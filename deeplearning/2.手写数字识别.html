<!DOCTYPE HTML>
<html lang="zh-cn" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>从手写数字识别入门深度学习 - 嵌入式与深度学习</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../deeplearning/1.深度学习入门介绍.html">深度学习简要介绍</a></li><li class="chapter-item expanded "><a href="../deeplearning/2.手写数字识别.html" class="active"><strong aria-hidden="true">1.</strong> 从手写数字识别入门深度学习</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../deeplearning/3.多层感知机(MLP)解析.html"><strong aria-hidden="true">1.1.</strong> 多层感知机(MLP)解析</a></li><li class="chapter-item expanded "><a href="../deeplearning/4.交叉熵损失函数.html"><strong aria-hidden="true">1.2.</strong> 交叉熵损失函数介绍</a></li><li class="chapter-item expanded "><a href="../deeplearning/5.反向传播算法.html"><strong aria-hidden="true">1.3.</strong> 反向传播算法介绍</a></li></ol></li><li class="chapter-item expanded "><a href="../misc/index.html"><strong aria-hidden="true">2.</strong> 杂项记录</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../misc/1.vscode_ssh.html"><strong aria-hidden="true">2.1.</strong> VSCode远程连接实验室windows电脑</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">嵌入式与深度学习</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<h2 id="手写数字数据集mnist介绍"><a class="header" href="#手写数字数据集mnist介绍"><strong>手写数字数据集MNIST介绍</strong></a></h2>
<p>手写数字数据集MNIST是一个常见的数字图片数据集，其包含了大量手写数字的灰度图像，每张图像的大小都是28x28像素。MNIST数据集有60000张图像用于训练和10000张图像用于测试，其中每张图像都被标记了对应的数字（0-9）。这个数据集非常简单，常常作为初学者的第一个 “Hello World” 项目。
<img src="./images/1.png" alt="" /></p>
<!-- more -->
<h2 id="上手操作"><a class="header" href="#上手操作"><strong>上手操作</strong></a></h2>
<p>为了方便初学者更好的学习，本项目采用编辑器VSCode和Python语言编写。</p>
<p>导入基本库，并加载MNIST数据集</p>
<pre><code class="language-python">import torch
import time
import torchvision
from torch.utils import data
from torch.autograd import Variable
from torchvision.datasets import mnist
import matplotlib.pyplot as plt
from torch import nn
import numpy as np
import itertools


'''固定随机种子，使得程序结果尽可能保证复现效果'''
seed = 1
torch.manual_seed(seed)


'''MINIST数据集预处理'''
data_tf = torchvision.transforms.Compose(
    [   
        #将原始数据转为tensor
        torchvision.transforms.ToTensor(), 
        # z-score 归一化，把MNIST中图片的像素分布拉回到 标准正态分布 N ~ (0, 1)
        torchvision.transforms.Normalize([0.1307],[0.3081]), 
    ]                                               
)


'''下载数据集'''
data_path =  'F:\\zhendianyuanzi_linux\\dataset\\images' # 自定义图片下载存放路径
train_data = mnist.MNIST(data_path, train=True, transform=data_tf, download = True)
test_data  = mnist.MNIST(data_path, train=False,transform=data_tf, download = True)
</code></pre>
<p>然后我们查看一下train_loader中的第一个batch中存放了什么</p>
<pre><code class="language-python">'''创建dataloader'''
batch_size = 128  #这里我们定义一个batch中存放128张图片
train_loader = data.DataLoader(train_data,batch_size=batch_size,shuffle=True) 
test_loader  = data.DataLoader(test_data, batch_size=batch_size,shuffle=False)

'''查看train_loader'''
for batch, (X, y) in enumerate(train_loader):
    #打印第一个batch中的shape
    print('X.shape:{}, y.shape:{}'.format(X.shape, y.shape))
    
    #显示第一batch中的第一张图片，和打印其对应的标签
    plt.imshow(X[0, 0], cmap = 'gray')
    print(y[0])
    break
</code></pre>
<p>运行这一行程序后，结果如下图所示。X表示一个batch中的样本，其shape为（128, 1, 28, 28），表示一个batch中一共有128个张图片，每张图片的通道数为1，每张图片对应的像素点个数是28x28。因为图片是灰度图像，所以只有1个通道，如果图片是彩色的，那么图片就有3个通道（即RGB）。y表示一个batch中样本所对应的标签，其值范围为从0到9。并且我们还把该batch中的第一张图片打印了出来，该图片是数字3，其对应的标签也是3。在读者的电脑上运行的时候，所显示的图片可能不是数字3，而是其他的数字。这是因为在这一句话中train_loader = data.DataLoader(train_data,batch_size=batch_size,shuffle=True)，我们开启了shuffle，值为True，这会让batch中的样本随机打乱，不固定。对于训练集train_loader中的样本必须要随机打乱，这样才能让模型更好地学习，并收敛。
<img src="./images/2.png" alt="" /></p>
<p>接下来我们定义网络模型结构，网络模型初步选择多层感知机（MLP）。</p>
<pre><code class="language-python">'''定义网络结构'''
class MLP(nn.Module):
    def __init__(self, hidden_dim, class_num):
        super(MLP, self).__init__()
        self.fc = nn.Sequential(
            nn.Flatten(),
            nn.Linear(28*28, hidden_dim),
            nn.Sigmoid(),
            nn.Linear(hidden_dim, class_num),
        )

    def forward(self, x):
        out = self.fc(x)
        return out

hidden_dim = 64 #隐藏层神经元个数
class_num  = 10 #由数字0到9，所以一共是10个类别
device = 'cuda' #使用 GPU设备，如果要使用cpu，请更改为 'cpu'
model = MLP(hidden_dim, class_num).to(device) # 把模型从内存中搬运到GPU中运行
print(model)
</code></pre>
<p>该模型的结构如下图所示
<img src="./images/3.png" alt="" /></p>
<p>定义训练函数train，和验证函数valid</p>
<pre><code class="language-python">def train(model, dataloader, loss_fn, optimizer, device):
    '''模型训练'''
    model.train() #很重要，开启模型的训练模式，保证batchnorm和dropout的参数是进行训练计算的
    loss_sum = 0; num_batches = 0
    y_true = []; y_pred = [] # y_true 和  y_pred 分别是真实的标签和模型预测的标签
    
    for batch, (X, y) in enumerate(dataloader):
        '''把图片喂给模型'''
        X = X.to(device)
        y = y.to(device)
        pred = model(X)
        _loss = loss_fn(pred, y)

        '''反向传播，更新模型参数'''
        optimizer.zero_grad()
        _loss.backward()
        optimizer.step()

        '''自定义变量参数更新'''
        loss_sum += _loss.item()
        num_batches += 1
        y_true.append( y.cpu().numpy())
        y_pred.append( pred.argmax(1).cpu().numpy())

        '''每经过200个batch就打印一次损失 '''
        if batch % 200 == 0:
            loss, current = _loss.item(), batch * len(X)
            print(f&quot;loss: {loss:&gt;7f}  [{current:&gt;5d}/{len(dataloader.dataset):&gt;5d}]&quot;)

    '''展平, 并将List变为Numpy数组'''
    y_true = np.array(list(itertools.chain.from_iterable(y_true)))
    y_pred = np.array(list(itertools.chain.from_iterable(y_pred)))

    return loss_sum/num_batches, y_true, y_pred


def valid(model, dataloader, loss_fn, device):
    '''模型验证 '''
    model.eval() #很重要，固定模型中的batchnorm和dropout，不然在验证阶段模型的参数会变动。
    loss_sum = 0; num_batches = 0
    y_true = []; y_pred = []

    with torch.no_grad(): # 验证阶段要禁止梯度的传播
        for batch, (X, y) in enumerate(dataloader):
            '''把图片喂给模型'''
            X = X.to(device)
            y = y.to(device)
            pred = model(X)
            _loss = loss_fn(pred, y)

            '''自定义变量参数更新'''
            loss_sum += _loss.item()
            num_batches += 1
            y_true.append( y.cpu().numpy())
            y_pred.append( pred.argmax(1).cpu().numpy())

        '''展平, 并将List变为Numpy数组'''
        y_true = np.array(list(itertools.chain.from_iterable(y_true)))
        y_pred = np.array(list(itertools.chain.from_iterable(y_pred)))

    return loss_sum/num_batches, y_true, y_pred
</code></pre>
<p>定义超参数、损失函数和优化器。</p>
<pre><code class="language-python">lr = 1e-3    #初始学习率设置
max_epoch = 5   #训练迭代次数

loss_fn = nn.CrossEntropyLoss()  #使用交叉熵损失
optimizer = torch.optim.Adam(model.parameters(), lr=lr)  #使用Adam优化器优化模型参数
</code></pre>
<p>开始训练。为了更加直观的学习，我们把MNIST的测试集当做验证集来使用。注意在实际中，验证集和测试集是要分开使用的，在后面的章节中我会详细地介绍训练集、验证集、测试集三者之间的关系。</p>
<pre><code class="language-python">for t in range(max_epoch):
    print(f&quot;Epoch {t+1}\n-------------------------------&quot;)
    train_loss, train_y, train_pred_y = train(model, train_loader, loss_fn, optimizer, device)
    valid_loss, valid_y, valid_pred_y = valid(model, test_loader, loss_fn, device)
    
    train_acc = sum(train_y == train_pred_y)/len(train_y)*100
    valid_acc = sum(valid_y == valid_pred_y)/len(valid_y)*100
    print(&quot;train accuracy:{}%, valid accuracy:{}%&quot;.format(train_acc, valid_acc))
</code></pre>
<p>训练的结果如下图所示，训练到第5个epoch后，发现验证集的准确率达到了95.46%，效果看起来还可以接受。如果想要获得更好的准确率，可以尝试使用不同的超参数组合，例如MLP模型隐藏神经元中的个数，学习率、最大训练迭代次数等。
<img src="./images/4.png" alt="" /></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../deeplearning/1.深度学习入门介绍.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../deeplearning/3.多层感知机(MLP)解析.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../deeplearning/1.深度学习入门介绍.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../deeplearning/3.多层感知机(MLP)解析.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
